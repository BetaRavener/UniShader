#include <UniShader/TextureUnit.h>
#include <UniShader/OpenGL.h>

#include <iostream>

using UNISHADER_NAMESPACE;

bool TextureUnit::m_initialized = false;
std::deque<char> TextureUnit::m_freeTextureUnits;

TextureUnit::TextureUnit():
m_index(-1),
m_locked(0){
	if(!m_initialized){
		ensureGlewInit();
		clearGLErrors();

		GLint max, mctiu;
		glGetIntegerv(GL_MAX_TEXTURE_COORDS, &max);
		glGetIntegerv(GL_MAX_COMBINED_TEXTURE_IMAGE_UNITS, &mctiu);
		if(max < mctiu)
			max = mctiu;
        if(max > 255)
            std::cerr << "More texture units should be allowed, report this to UniShader forums" << std::endl;
		for(int i = 0; i < max; i++)
			m_freeTextureUnits.push_back((char)i);

		m_initialized = true;
	}
}

TextureUnit::~TextureUnit(){
	if(m_locked)
		m_freeTextureUnits.push_front(m_index);
}

void TextureUnit::lock(){
	if(m_locked)
		return;

	if(m_freeTextureUnits.size() == 0){
		std::cerr << "ERROR: Number of active textures exceeds number of texture units" << std::endl;
		return;
	}
	else{
		m_index = m_freeTextureUnits.front();
		m_locked = true;
	}
}

bool TextureUnit::makeActive(){
	if(m_locked){
		ensureGlewInit();
		clearGLErrors();

		glActiveTexture(GL_TEXTURE0+m_index);
		return (!printGLError());
	}
	else{
		std::cerr << "ERROR: Texture unit must be locked before activating" << std::endl;
		return FAILURE;
	}
}

char TextureUnit::getIndex() const{
	return m_index;
}

void TextureUnit::release(){
	if(!m_locked)
		return;

	m_freeTextureUnits.push_front(m_index);
	m_index = -1;
	m_locked = false;
}